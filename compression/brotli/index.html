<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brotli</title>
    <link rel="stylesheet" href="./../../styles.css">
</head>
<body>
    <ul class="breadcrumb">
        <li><a href="./../../">アルゴリズムの学習</a></li>
        <li><a href="./../">圧縮・解凍問題</a></li>
        <li>Brotli</li>
    </ul>

    <div class="container">
        <h1>Brotli</h1>
        <div class="section">
            <h2>アルゴリズムの概要</h2>
            <p>Brotliは、2013年にGoogleによって開発された汎用データ圧縮アルゴリズムです。LZ77アルゴリズムの変種と最適コンテキストモデリング、ハフマン符号化を組み合わせた高度な可逆圧縮方式であり、特にウェブコンテンツの圧縮に最適化されています。このアルゴリズムは、高い圧縮率とそれに対して合理的な解凍速度を提供することを目的に設計されました。</p>
            
            <h3>基礎知識</h3>
            <p>Brotliは、既存の圧縮技術の強みを組み合わせて拡張した圧縮アルゴリズムです。具体的には、LZ77による辞書圧縮をベースに、コンテキストモデリングとハフマン符号化を組み合わせています。また、あらかじめ用意された静的辞書を使用することで、特にウェブフォント、HTML、CSS、JavaScriptなどのウェブコンテンツの圧縮に高い効率を発揮します。</p>
            <p>Brotliの特徴的な点は、複数の圧縮レベル（1〜11）を提供し、圧縮率と圧縮速度のバランスをユースケースに応じて調整できることです。低レベルでは速度を優先し、高レベルでは最大の圧縮率を達成するための詳細な分析が行われます。また、解凍処理は圧縮レベルに関わらず高速に実行できるよう設計されています。</p>
            
            <h3>用語説明</h3>
            <ul>
                <li><strong>LZ77</strong>: 繰り返しデータを参照に置き換えることで圧縮する辞書型圧縮アルゴリズム</li>
                <li><strong>ハフマン符号化</strong>: 出現頻度に基づいて可変長の符号を割り当てる圧縮手法</li>
                <li><strong>コンテキストモデリング</strong>: 直前のデータに基づいて、次に現れるデータの確率を予測する技術</li>
                <li><strong>静的辞書</strong>: あらかじめ用意された共通パターンの辞書で、圧縮効率を高めるために使用される</li>
                <li><strong>動的辞書</strong>: 圧縮過程で構築される、対象データに特化した辞書</li>
                <li><strong>スライディングウィンドウ</strong>: 直前のデータを参照するための一定範囲のバッファ</li>
                <li><strong>バックリファレンス</strong>: 既に処理されたデータへの参照</li>
                <li><strong>メタブロック</strong>: Brotliでのデータ処理単位</li>
                <li><strong>圧縮レベル</strong>: 圧縮率と速度のトレードオフを調整するためのパラメータ</li>
                <li><strong>エントロピー符号化</strong>: 情報理論に基づいて冗長性を削減する符号化手法</li>
            </ul>
            
            <h3>特徴</h3>
            <p>Brotliの主な特徴は以下の通りです：</p>
            <ul>
                <li>GzipやDeflateと比較して15〜25%高い圧縮率を実現</li>
                <li>圧縮処理は比較的計算コストが高いが、解凍処理は高速</li>
                <li>複数の圧縮レベル（1〜11）により用途に応じた調整が可能</li>
                <li>静的辞書（約120KBの共通パターン）を使用して繰り返しの多いウェブコンテンツに対して効率的</li>
                <li>コンテキストモデリングによる高度な予測を活用した圧縮</li>
                <li>複数のハフマンツリーを使用した効率的な符号化</li>
                <li>最大16MBまでのウィンドウサイズをサポート</li>
                <li>圧縮済みサイズの接頭辞が不要（自己完結型のフォーマット）</li>
                <li>圧縮ストリームの連結が可能（複数のファイルを連結して圧縮可能）</li>
                <li>オープンソースで、様々なプラットフォームで利用可能</li>
            </ul>
            
            <h3>適用ケース</h3>
            <p>Brotliは以下のような場面で特に有用です：</p>
            <ul>
                <li>ウェブコンテンツ配信の最適化（特にHTTP圧縮として）</li>
                <li>CDN（コンテンツデリバリーネットワーク）でのコンテンツ圧縮</li>
                <li>帯域幅が制限されたモバイル環境でのデータ転送</li>
                <li>静的ウェブリソース（HTML、CSS、JavaScript、フォント）の圧縮</li>
                <li>オフライン閲覧用のウェブコンテンツ保存</li>
                <li>テキストベースのファイル形式の保存容量削減</li>
                <li>APIレスポンスの圧縮による通信効率化</li>
                <li>長期保存を目的としたアーカイブ（高圧縮レベルを使用）</li>
                <li>バックアップシステムでのデータ圧縮</li>
                <li>ウェブフォントの配信最適化（WOFF2フォーマットの基盤技術）</li>
            </ul>
        </div>
    
        <div class="section">
            <h2>アルゴリズムの手順</h2>
            <h3>具体的な手順</h3>
            <p>Brotli圧縮アルゴリズムの処理は、大きく分けて以下の手順で実行されます：</p>
            
            <h4>1. 前処理</h4>
            <ol>
                <li>入力データをメタブロックに分割する：
                    <ul>
                        <li>メタブロックは圧縮の基本単位</li>
                        <li>各メタブロックは独立して圧縮可能</li>
                        <li>最大16MBのサイズまでサポート</li>
                    </ul>
                </li>
                <li>静的辞書の準備：
                    <ul>
                        <li>約120KBの共通パターンを含む辞書を読み込む</li>
                        <li>ウェブコンテンツに特化した単語、フレーズ、その他のパターンを含む</li>
                        <li>辞書エントリは長さごとにグループ化されている</li>
                    </ul>
                </li>
                <li>圧縮パラメータの設定：
                    <ul>
                        <li>圧縮レベルの選択（1〜11）</li>
                        <li>ウィンドウサイズの決定</li>
                        <li>バックリファレンスの検索方法の設定</li>
                    </ul>
                </li>
            </ol>
            
            <h4>2. LZ77圧縮（マッチング探索）</h4>
            <ol>
                <li>入力データを順次走査：
                    <ul>
                        <li>現在位置からのデータブロックを取得</li>
                        <li>過去のデータ（スライディングウィンドウ内）または静的辞書内で一致するパターンを検索</li>
                    </ul>
                </li>
                <li>最適なマッチの選択：
                    <ul>
                        <li>複数のマッチが見つかった場合、圧縮効率が最大になるものを選択</li>
                        <li>マッチの長さと位置（距離）を記録</li>
                        <li>マッチが見つからない場合、リテラル（元のデータ）として記録</li>
                    </ul>
                </li>
                <li>圧縮モードの選択：
                    <ul>
                        <li>各種データタイプ（リテラル、距離、長さ）に対して最適な符号化方式を選択</li>
                        <li>コンテキスト（前後のデータパターン）を考慮した予測モデルを適用</li>
                    </ul>
                </li>
            </ol>
            
            <h4>3. コンテキストモデリングとハフマン符号化</h4>
            <ol>
                <li>コンテキストモデルの構築：
                    <ul>
                        <li>直前のデータに基づいて、次のシンボルの確率分布を予測</li>
                        <li>リテラル、距離、長さそれぞれに対して別々のコンテキストモデルを使用</li>
                        <li>コンテキストはデータ内容と位置の両方に依存</li>
                    </ul>
                </li>
                <li>ハフマンツリーの生成：
                    <ul>
                        <li>各コンテキストごとに出現頻度を分析</li>
                        <li>複数のハフマンツリーを構築（最大で256個のコンテキスト別ツリー）</li>
                        <li>出現頻度の高いシンボルには短い符号を、低いシンボルには長い符号を割り当て</li>
                    </ul>
                </li>
                <li>ハフマン符号化の適用：
                    <ul>
                        <li>リテラル、長さ、距離の各データを対応するハフマン符号に変換</li>
                        <li>コンテキストに基づいて適切なハフマンツリーを選択</li>
                        <li>符号化されたビット列を出力ストリームに追加</li>
                    </ul>
                </li>
            </ol>
            
            <h4>4. ビットストリームの最終化</h4>
            <ol>
                <li>メタデータの追加：
                    <ul>
                        <li>使用したウィンドウサイズなどの圧縮パラメータ</li>
                        <li>ハフマンツリーの構造情報</li>
                        <li>コンテキストマップ情報</li>
                    </ul>
                </li>
                <li>メタブロックのヘッダー構築：
                    <ul>
                        <li>メタブロックのサイズ情報</li>
                        <li>使用した圧縮モードの情報</li>
                        <li>非圧縮データが含まれるかどうかのフラグ</li>
                    </ul>
                </li>
                <li>圧縮ストリームの最終化：
                    <ul>
                        <li>各メタブロックを連結</li>
                        <li>ストリーム終端マーカーの追加</li>
                        <li>バイトアライメントの調整（必要に応じて）</li>
                    </ul>
                </li>
            </ol>
    
            <h3>計算量</h3>
            <p>Brotliアルゴリズムの計算量は以下の通りです：</p>
            
            <h4>時間計算量</h4>
            <ul>
                <li><strong>圧縮処理</strong>:
                    <ul>
                        <li>レベル1（最高速）: O(n)</li>
                        <li>レベル9（デフォルト）: O(n log n)</li>
                        <li>レベル11（最高圧縮率）: O(n²) 最悪の場合</li>
                        <li>n：入力データのサイズ</li>
                        <li>実際の計算量は選択した圧縮レベルと入力データの特性に大きく依存</li>
                    </ul>
                </li>
                <li><strong>解凍処理</strong>: O(m)
                    <ul>
                        <li>m：圧縮後のデータサイズ</li>
                        <li>解凍は比較的高速で、圧縮レベルに関わらず一定の速度</li>
                    </ul>
                </li>
            </ul>
            
            <h4>空間計算量</h4>
            <ul>
                <li><strong>圧縮処理</strong>:
                    <ul>
                        <li>O(w + d + h)</li>
                        <li>w：ウィンドウサイズ（最大16MB）</li>
                        <li>d：静的辞書サイズ（約120KB）</li>
                        <li>h：ハフマンツリーとコンテキストモデルのメモリ</li>
                        <li>高圧縮レベルでは追加のメモリが必要（中間データ構造用）</li>
                    </ul>
                </li>
                <li><strong>解凍処理</strong>: O(w + d)
                    <ul>
                        <li>圧縮より少ないメモリで動作可能</li>
                        <li>主にウィンドウバッファと静的辞書のスペースが必要</li>
                    </ul>
                </li>
            </ul>
            
            <p>Brotli圧縮の大きな特徴は、圧縮と解凍の非対称性にあります。圧縮処理は特に高レベルで計算負荷が高く、時間がかかる場合がありますが、解凍処理はいずれの圧縮レベルでも効率的に実行できるよう設計されています。これにより、サーバー側で一度圧縮したデータを多数のクライアントが解凍して利用するウェブコンテンツ配信のようなシナリオに特に適しています。</p>
            
            <p>圧縮率と処理速度のバランスは、選択する圧縮レベルによって大きく変わります。レベル1〜3は高速処理を重視し、レベル4〜7はバランス、レベル8〜11は圧縮率を最大化するための詳細な分析を行います。実用的には、静的コンテンツの事前圧縮には高レベル（9〜11）、オンデマンド圧縮には中レベル（4〜6）が選ばれることが多いです。</p>
            
            <p>また、Brotliは特にテキストベースのデータ（HTML、CSS、JavaScript、XMLなど）に対して高い圧縮効率を示します。バイナリデータに対しても他の圧縮アルゴリズムと同等以上の性能を発揮しますが、特にウェブコンテンツ向けに最適化されている点がその強みです。</p>
        </div>
    </div>
</body>
</html>